{% extends "base.html" %}
{% block content %}

<div class="container mt-5">

    <!-- PAGE TITLE -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0">Transactions Report</h2>

        {% if selected_customer %}
        <a href="{% url 'transactions:transactions_report' %}?customer_id={{ selected_customer }}&from_date={{ from_date }}&to_date={{ to_date }}&download=invoice"
           class="btn btn-dark shadow-sm">
            ðŸ“„ Download Invoice PDF
        </a>
        {% endif %}
    </div>

    <!-- FILTER SECTION -->
    <div class="card shadow-sm mb-4 p-3">
        <form method="GET" class="row g-3">

            <div class="col-md-3">
                <label class="form-label">Customer</label>
                <select name="customer_id" class="form-select">
                    <option value="">-- All Customers --</option>
                    {% for c in customers %}
                        <option value="{{ c.id }}"
                                {% if c.id|stringformat:"s" == selected_customer|stringformat:"s" %}selected{% endif %}>
                            {{ c.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" name="from_date" class="form-control" value="{{ from_date }}">
            </div>

            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" name="to_date" class="form-control" value="{{ to_date }}">
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100 me-2">Filter</button>
                <a href="{% url 'transactions:transactions_report' %}" class="btn btn-secondary w-100">Clear</a>
            </div>

        </form>
    </div>

    <!-- OPENING & CLOSING BALANCE -->
    {% if opening_range_balance is not None %}
<div class="alert alert-warning mb-4">
    <strong>Opening Balance for Selected Range:</strong>
    {% if opening_range_balance < 0 %}
        Adv {{ opening_range_balance|stringformat:"f"|slice:"1:6" }} g
    {% else %}
        Bal {{ opening_range_balance|floatformat:3 }} g
    {% endif %}
</div>

<div class="alert alert-success mb-4">
    <strong>Closing Balance for Selected Range:</strong>
    {% if closing_range_balance < 0 %}
        Adv {{ closing_range_balance|stringformat:"f"|slice:"1:6" }} g
    {% else %}
        Bal {{ closing_range_balance|floatformat:3 }} g
    {% endif %}
</div>
{% endif %}

    <!-- SILVER GIVEN TABLE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white"><strong>Silver Given</strong></div>
        <div class="card-body p-0">

            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Weight (g)</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for s in silver_records %}
                        <tr>
                            <td>{{ s.customer.name }}</td>
                            <td>{{ s.weight|floatformat:3 }}</td>
                            <td>{{ s.date|date:"d M, Y" }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">No Silver Given</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
        <div class="card-footer"><strong>Total Silver Given:</strong> {{ total_given|floatformat:3 }} g</div>
    </div>

    <!-- PRODUCT RETURNS TABLE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white"><strong>Product Returns</strong></div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Product</th>
                            <th>Gross (g)</th>
                            <th>Pure (g)</th>
                            <th>MC</th>
                            <th>Date</th>
                            <th>MC Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for r in return_records %}
                        <tr>
                            <td>{{ r.customer.name }}</td>
                            <td>{{ r.product.name }}</td>
                            <td>{{ r.gross_weight|floatformat:3 }}</td>
                            <td>{{ r.pure_weight|floatformat:3 }}</td>
                            <td>{{ r.mc_amount|floatformat:3 }}</td>
                            <td>{{ r.date|date:"d M, Y" }}</td>
                            <td>
                                {% if r.mc_given %}
                                    <span class="badge bg-success">Given</span>
                                {% else %}
                                    <span class="badge bg-danger">Not Given</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No Product Returns</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer"><strong>Total Silver Returned:</strong> {{ total_return|floatformat:3 }} g</div>
    </div>

    <!-- CURRENT BALANCE -->
    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <h5>Current Balance</h5>
            <div class="alert alert-info mb-0" style="font-size: 1.2rem;">
                {% if current_balance < 0 %}
                    <strong>Adv {{ current_balance|stringformat:"f"|slice:"1:6" }} g</strong>
                {% else %}
                    <strong>Bal {{ current_balance|floatformat:3 }} g</strong>
                {% endif %}
            </div>
        </div>
    </div>

</div>

{% endblock %}
